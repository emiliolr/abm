---
title: "Project 3: Predicting Movement in Eswatini with a Gravity Model"
author: Emilio Luz-Ricca
output:
  html_document:
    toc: true
    number_sections: true
    highlights: pygments
---

```{r setup, include = FALSE}
library(tidyverse)
library(sf)
library(knitr)

load("for_gravity_model.RData")
load("for_P3_writeup.RData")

knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center", echo = FALSE, out.width = "70%")
```

<!--TODO: make presentation of tables/matrices nicer-->
<!--TODO: clean up writing + do general editing on the deliverable-->

# Outline 

In this project, I used first level administrative subdivision movement data to produce a national-level gravity model for internal migration flows in Eswatini. Then, I used this model to predict movement flows between urban areas for my selected lower-level administrative subdivision, Mkhiweni. I also produced a number of animations to visualize observed movement. In this deliverable, I summarize these procedures and comment on how this analysis could be extended and improved.

# Working with Movement Data

[WorldPop](https://www.worldpop.org/) has curated a variety of data for many low and middle income countries (LMICs). For this project, I used [district-level movement data](https://www.worldpop.org/geodata/summary?id=1281) for Eswatini as the basis for my gravity model. This data was produced by applying an unconstrained gravity type spatial interaction model to World Health Organization data for sub-national movement from 2015. Movement is at a five year temporal resolution for this data set.

After reading in the data, I spent several days exploring and visualizing the data. In total, flows in the data sum out to $\approx$ 15330, i.e., WorldPop projects that 15330 people moved from one district to another in this five year period. Next, I produced an origin-destination matrix (OD matrix) that summarizes movement between districts as observed in the WorldPop data.

```{r od-matrix}
kable(OD_matrix %>% mutate(origin_node = 1:4) %>% select(origin_node, everything()))
```

Notice that the row IDs (one through four) indicate the origin district and the column IDs the destination. There are NA values along the diagonal as we are interested only in the _flows_. The coding scheme for the districts, which I will stick to throughout this write-up, is: 1 - Hhohho; 2 - Lubombo; 3 - Manzini; 4 - Shiselweni. I have included a plot showing this coding scheme below, along with the centroid locations for each district.

```{r coding-scheme}
worldpop_centroid_data <- read_sf("Data/SWZ_5yrs_InternalMigFlows_2010/SWZ_AdminUnit_Centroids/SWZ_AdminUnit_Centroids.shp")
swz_adm1 <- read_sf("Data/gadm36_SWZ_shp/gadm36_SWZ_1.shp")

ggplot() +
  theme_void() +
  geom_sf(data = swz_adm1, fill = "lightskyblue1", color = "black") +
  geom_sf_text(data = swz_adm1, mapping = aes(label = NAME_1), alpha = 0.3, size = 6) +
  geom_sf(data = worldpop_centroid_data) +
  geom_sf_text(data = worldpop_centroid_data, mapping = aes(label = IPUMSID), nudge_y = -0.05)
```

In addition to the OD matrix, I created a matrix that included the distances between all district _centroids_, which is generally the standard procedure for calculating distance between region when inputting into a gravity model (more on this later).

```{r dist-matrix}
kable(dist_matrix %>% mutate(origin_node = 1:4) %>% select(origin_node, everything()))
```

Notice that this matrix is symmetric while the OD matrix is not. In the OD matrix, movement from district $i$ to district $j$ is not necessarily equal to movement from district $j$ to district $i$. However, distance between two districts doesn't change based on which node you start from, hence the symmetric nature of the second matrix.

Finally, I produced a plot visualizing the information contained in the OD matrix. The crosses represent the quantity of in-flows and the filled-in circles represent the quantity of out-flows.

```{r in-out-flows}
ggplot() + #leaving/coming into the centroid
  theme_void() +
  geom_sf(data = swz_adm1, fill = "lightskyblue1", color = "black") +
  geom_sf(data = origin_summarized, mapping = aes(fill = migration), size = 5, shape = 21, 
          color = "lightskyblue1") +
  geom_sf(data = destinations_summarized, mapping = aes(color = migration), size = 6, shape = 13, 
          fill = NA, show.legend = FALSE) +
  scale_color_viridis_c(option = "cividis") +
  scale_fill_viridis_c(option = "cividis") +
  labs(fill = "Migration Flows")
```

## Animating Movement

To make these visualizations of movement more visually interesting, I used the `gganimate` package to animate movement flows as observed in the data. First, I produced a simple animation where only one agent moved from the centroid of Hhhohho to the centroid of Lubombo. 

```{r basic-move-anim, out.width = "50%"}
knitr::include_graphics("Figures/moving_person.gif")
```

Then, I worked adding more agents and varying the movement speeds. Having variable movement speeds wasn't really necessary for the final product, but it was a good exercise in working with `gganimate`.

```{r 2nd-move-anim, out.width = "50%"}
knitr::include_graphics("Figures/moving_many_people.gif")
```

Next, I had agents move to/from all centroids. This required quite a bit more data wrangling and spatial computation than the previous two animations.

```{r 3rd-move-anim, out.width = "50%"}
knitr::include_graphics("Figures/moving_people_all_districts.gif")
```

And finally, I increased the number of agents moving from district to district. Unfortunately, I couldn't figure out how to do this in an entirely robust manner, so I ended having to hard-code quite a few things. Still, as a proof of concept, this is a pretty neat animation! To produce this animation, I used `ggplot::geom_jitter()` to displace the agents and give them each their own movemtn path from district to district. Then, I resized the number of agents proportionally to the match the magnitude of observed flows in the WorldPop data set (this is animation is at $\frac{1}{25}$ scale). To make the hard-coding a little easier, I focused on only the out-flows from Hhhohho.

```{r 4th-move-anim, out.width = "50%"}
knitr::include_graphics("Figures/moving_people_lots_of_people.gif")
```

# Getting Started with Gravity Models

<!--TODO: add in any visual results from the vignette?-->

As a first exercise in working with gravity models, I followed along with a short vignette on basic gravity model estimation procedures (you can find this exercise [here](https://rpubs.com/adam_dennett/257231)). This vignette helped me get acquainted with the most basic form of the gravity model, which is generally presented as: $$T_{ij} = \frac{P^{\alpha}_{i}P^{\beta}_{j}}{D_{ij}}$$ This can be broken down as follows:

- $T_{ij}$ is the flow from node $i$ to node $j$,
- $P_{i}$ is the population at node $i$ and $P_{j}$ is the population at node $j$, and
- $D_{ij}$ is the distance from node $i$ to node $j$.

This is a really neat way of modeling migration. Basically, we apply the equation for gravity between two masses to migration flows, noticing that there are certain push or pull factors ($P_i$ and $P_j$), as well as a certain "friction" factors that might hinder movement between two locations ($D_{ij}$). This basic model can be extended to include more push or pull factors, then being considered a gravity-type spatial interaction model (GTSIM).

In the vignette, we used commuter movement data between London boroughs. Notice that this movement is at a much finer temporal granularity than the WorldPop data for Eswatini. The key difference is the London data contains short-term movement decisions (based on work-related commutes), whereas the Eswatini data represents much longer-term movement decisions. The vignette covered how to wrangle the data into the appropriate form, how to produce an OD matrix, and different ways to approach the gravity model. It showed that, while it is possible to achieve reasonably good results when just picking the model parameters using intuition ($\alpha$, $\beta$, $\gamma$), we can improve the accuracy by estimating the parameters using the data and leveraging a Poisson regression model. From the less refined to the more refined approach, we saw an improvement in the $R^2$ from 0.503 to 0.673.

With these practical results in minds, I moved next towards the comprehensive paper _Modeling internal migration flows in sub-Saharan Africa using census microdata_ from Garcia et al (see the article [here](https://academic.oup.com/migration/article/3/1/89/2413406)). In this paper, the authors explore the utility of GTSIMs for predicting domestic migration flows in Sub-Saharan Africa, exploring the potential for cross-country and cross-temporal applicability. They included a suite of push/pull factors in their analysis, including urban population, whether or not the locations were contiguous, and the proportion of the population that was male. They found that, while the GTSIM performed very well for certain countries (i.e., Senegal and Ghana), it performed consistently poorly in others (i.e., Malawi). Likewise, in their exploration of cross- country and temporal application, they found some possibility of strong prediction in varied settings, but only for those countries whose movement was well predicted with their own GTSIM. This implies that GTSIMs do perform well generally, but there are likely certain intrinsic elements that cause GTSIMs to systematically perform poorly on certain countries.

# Producing a Gravity Model for Eswatini

At this point, I had everything that I needed to produce a gravity model for Eswatini at the district level. Before estimating the model, I first brought in a few additional variables as potential push/pull factors: nighttime lights and the population for each district. For both of these, I used WorldPop raster data and extracted/aggregated to each district. The final data set (with all twelve origin/destination combinations) is included below ("ntl" is used as an abbreviation for nighttime lights).

```{r district-data-set}
final_flow_data %>% 
  dplyr::select(-ISO) %>%
  rename(origin_district = NODEI, destination_district = NODEJ, migration_flows = PrdMIG, distance = dist) %>%
  kable()
```

This data was then used as input into a Poisson Pseudo Maximum Likelihood (PPML) gravity model, using the implementation in the [`gravity`](https://pacha.dev/gravity/articles/crash-course-on-gravity-models.html#poisson-pseudo-maximum-likelihood-ppml) library. I also tried a Double Demeaning (DDM) model, but the results were not easily interpretable because of the transformations applied in the estimation. Below, I've included a matrix of the model residuals for PPML to show that the fit is reasonably good (comparison with the OD matrix from Section 2 might be needed to properly interpret these results).

```{r resid-matrix}
resid_matrix %>% kable()
```

At this point, we should be a little worried about skewed results in our PPML model given that there aren't many data points to estimate the model on. Additionally, distance is really the only strong predictor amongst our pool of variables (all but distance have very small coefficient estimates), which may also cause issues. Still, this seems to be a good fit at the district level at least.

# Attempting to Predict Movement Flows in Mkhiweni

Before applying the national level model to Mkhiweni (my selected second-level administrative unit), I produced a Voronoi tessellation using the centroids of the twelve de facto urban areas in Mkhiweni (these are from [Project 1](https://emiliolr.github.io/abm/description_of_settlements.html)). This acts as a clean, but somewhat artificial, partition of the space within Mkhiweni.

```{r voronoi-plot}
ggplot() + 
  theme_void() +
  geom_sf(data = swz_mk, fill = "lightskyblue1") +
  geom_sf(data = urban_areas, fill = "maroon", color = "maroon") +
  geom_sf(data = urban_centroids) +
  geom_sf(data = mk_voronoi_adm2, alpha = 0, color = "black")
```

Notice that the Voronoi polygons don't perfectly partition the urban areas, just the _centroids_ for each urban area. At this point, I made the decision to use the Voronoi polygons as the polygons to extract and aggregate nighttime lights and population to (as opposed to the urban polygons themselves). This was probably not the correct decision to make here, but I wanted to use the Voronoi polygons in a meaningful way. Also, nighttime lights and population aren't strong predictors, so the difference here in terms of prediction accuracy is likely negligible. So, I collected all of the necessary variables and used the fitted PPML model to predict flows between urban areas in Mkhiweni. An excerpt of the predicted OD matrix for the twelve urban areas is included below. 

```{r mk-pred-flows}
mk_pred_flows %>% 
  pivot_wider(names_from = centroid_to, values_from = pred_flows) %>%
  dplyr::select(centroid_from, `1`, everything()) %>%
  rename(origin_node = centroid_from) %>% 
  dplyr::select(origin_node:`5`) %>%
  filter(origin_node %in% 1:5) %>%
  kable()
```

It's worth mentioning that the coding for the nodes is not the same as the original, district-level node coding. In total there are 144 cells in this matrix, but only 25 cells are included above. We should immediately be suspicious of these results: many of the flows are on the order of 10^4^, but only around 30000 people live in Mkhiweni. These flows do not seem reasonable for five year movement in Mkhiweni. There are quite a few possible explanations for these skewed predictions, but the most convincing is the fact that distance is our only strong predictor; since distances between centroids are much smaller here than at the district level, we have significantly less "friction" with no strong push/pull factors to balance out the predictions. Still, as a proof of concept, it's exciting to see everything come together to form predictions for Mkhiweni, even if the predictions are likely extremely biased.

## Improving the Model

<!--
TODO:
  -generally, talk about how we could improve the gravity model 
    -are there issues w/using a national-level model for a smaller region... ideas from Garcia et al.?
      -not enough explan vars to have good preds at this level
      -what explan vars could be added?
    -talk about improving the temporal + spatial granularity of the gravity model
      -we'd need better data
  -think about how the animation could be improved + how these results could be animated
-->

