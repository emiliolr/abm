---
title: "Description of De Facto Settlements"
author: "Emilio Luz-Ricca"
output:
  html_document:
    toc: true
    number_sections: true
---

<!--if you are EVER going to do stuff with sf objects, import the library--otherwise, things will break!!!-->
```{r setup, include = FALSE}
library(knitr)
library(units)
library(tidyverse)
library(sf)
library(raster)

load("population_with_sf.Rdata")
knitr::opts_chunk$set(warning = FALSE, message = FALSE, fig.align = "center", echo = FALSE, out.width = "70%")
```

# Quick Note

This file is a _work in progress_! I wasn't able to complete the exercise due to some roadblocks (which you will see later).

# Choosing an Administrative Subdivision

The first time I attempted this exercise, I tried to use the region **Manzini** for my analysis. Unfortunately, I got stuck on the bandwidth calculation (`bw.ppl()` from) for the spatial probability distribution function (I let it run for more than an hour and a half before interrupting the process). Manzini has a relatively large population ($\approx$ `r swz_adm1 %>% filter(NAME_1 == "Manzini") %>% .[[ncol(swz_adm1)]] %>% floor() %>% format(scientific = FALSE)`) and is somewhat large in area ($\approx$ `r swz_adm1 %>% filter(NAME_1 == "Manzini") %>% st_area() %>% set_units("km^2") %>% as.numeric() %>% round(2)` km^2^), which may be the reason that this computation was taking so long.

So, I decided to switch away from Manzini towards a smaller, less populous area. I settled on the tinkhundla **Mkhiweni** (population $\approx$ `r swz_adm2 %>% filter(NAME_2 == "Mkhiweni") %>% .[[ncol(swz_adm2)]] %>% floor() %>% format(scientific = FALSE)`, area $\approx$ `r swz_adm2 %>% filter(NAME_2 == "Mkhiweni") %>% st_area() %>% set_units("km^2") %>% as.numeric() %>% round(2)` km^2^), which is actually in the Manzini district.

# Subsetting the Raster and Producing a PPP

Once I had decided on using Mkhiweni, things went much more smoothly. I was able to `crop` and `mask` my population raster quite easily.

```{r mk-raster-and-sf}
include_graphics("Figures/mkhiweni_pop20.png")
```

Next, I worked towards producing a planar point pattern (PPP) for Mkhiweni. This took a little while to compute but went relatively smoothly.

```{r mk-ppp}
include_graphics("Figures/mk_ppp.png")
```

The biggest issue that I have with this plot is the fact that it gets compressed pretty significantly when saving it (you can see the decrease in resolution with the apparent square groupings that shouldn't exist).

# Extracting the Probability Density Function and Addding a Contour Line

Having been able to actually compute the bandwidth for the spatial probability density function (PDF), I created a density plot. The PDF is based off of the PPP which is based off of the original population raster.

```{r mk-density}
include_graphics("Figures/mk_density.png")
```

Using an arbitrary cutoff, I defined a contour line that aims to separate the densely-populated from the sparsely-populated areas. Adding this contour line to the density plot begins to reveal the goal for this exercise, extracting the polygons that define the populous areas within Mkhiweni.

```{r mk-density-w-contour}
include_graphics("Figures/mk_density_w_contour.png")
```

# Extracting the Polygons that Define the De Facto Settlements

This is the part where things stopped working out for me. When trying to isolate the polygons that define the settlement areas, most of my areas are nestled right on the border of Mkhiweni. Unfortunately, the lines from the contours don't extend all the way to the border, leaving us just short of being able to use `st_difference()` to turn these regions into discrete polygons.

```{r mk-issue}
include_graphics("Figures/example.png")
```

I tried to perform a scale transformation ( doing something like `st_geometry(OBJECT) * CONSTANT`) on the `sf` object, but this messed with the projection. I'm still trying to figure out how to remedy this issue. **More will be added once I can get passed this!**

